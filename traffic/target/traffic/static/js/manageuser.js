jQuery(function(d){var a="#grid-table";var b="#grid-pager";jQuery(a).jqGrid({url:G_CTX_PATH+"/manage/role/dataTables",datatype:"json",mtype:"GET",width:"300",height:"320",colNames:["用户id","姓名","英文名","登录账号","性别","手机号码","联系电话","email"],colModel:[{name:"userId",index:"userId",width:8,sortable:false,hidden:true},{name:"userName",index:"userName",width:8,sortable:false},{name:"engName",index:"engName",width:18,sortable:false},{name:"loginName",index:"loginName",width:25,sortable:false},{name:"sexStr",index:"sexStr",width:8,sortable:false},{name:"mobile",index:"mobile",width:12,sortable:false},{name:"telephone",index:"telephone",width:8,sortable:false},{name:"email",index:"email",width:8,sortable:false}],jsonReader:{root:"rows",total:function(f){var e=f.total;var g=parseInt(d("#grid-table").getGridParam("rowNum"));return e%g>0?e/g+1:e/g},page:"page",records:"total",repeatitems:false},postData:{},viewrecords:true,rowNum:10,rowList:[10,20,30],pager:b,altRows:true,multiboxonly:true,loadComplete:function(){var e=this;setTimeout(function(){updatePagerIcons(e)},0)},autowidth:true});function c(){d("#grid-table").jqGrid("setGridParam",{page:1});d("#grid-table").jqGrid("setGridParam",{postData:{userName:d("#username").val(),loginName:d("#loginname").val(),},datatype:"json"}).trigger("reloadGrid")}d("#manageuserSearchBtn").on("click",function(){c()});d.post(G_CTX_PATH+"/manage/role/ajaxList",function(e){d("#checkedRoleIds").append("<option value=''>----请选择角色----</option>");d(e).each(function(){var f=d("<option value='"+this.roleId+"'>"+this.roleName+"</option>");d("#checkedRoleIds").append(f)});d(e).each(function(){var f=d("<option value='"+this.roleId+"'>"+this.roleName+"</option>");d("#newcheckedRoleIds").append(f)})});d("#addSysUserBtn").on("click",function(){d("#addUserForm")[0].reset();d("#addUserModal").modal();Hg.refRepeatSubmit("addUserForm")});d.validator.addMethod("verifyName",function(g,e){var f=/^[a-zA-Z\u4e00-\u9fa5]{2,20}$/;return this.optional(e)||f.test(g)},"输入2~20位英文或中文姓名！");d.validator.addMethod("isMobile",function(g,e){var f=/^1\w{10}$/;return this.optional(e)||f.test(g)},"手机号格式不正确！");d.validator.addMethod("isPassword",function(g,e){var f=/[A-Za-z0-9]{6,10}/;return this.optional(e)||f.test(g)},"请输入6-10位字母、数字组成的字符串！");d("#addUserForm").validate({rules:{loginName:{required:true,verifyName:true},userName:{required:true,verifyName:true},plainPassword:{required:true,isPassword:true},mobile:{required:true,isMobile:true}}});d("#addUserForm [tag=save]").click(function(){if(!d("#addUserForm").validate().form()){return false}var f=d(this);f.addClass("disabled").removeClass("btn-primary");var e=d("#addUserForm").serializeArray();d.ajax({type:"POST",url:G_CTX_PATH+"/manage/role/addUser",data:e,success:function(g,i,h){if(g.success){ui_alert("保存成功",function(){d("#addUserModal").modal("hide");c()})}else{ajaxExceptionHandler(h,function(){Hg.refreshSubmitToken("addUserForm");ui_error(g.data)})}},complete:function(g,h){f.addClass("btn-primary").removeClass("disabled")}})});d("#deleteSysUserBtn").on("click",function(){var f=jQuery("#grid-table").jqGrid("getGridParam","selrow");if(f){var e=jQuery("#grid-table").jqGrid("getRowData",f);d("#deleteUserLoginName").html("确认删除用户【"+e.userName+"】吗？");d("#deleteUserId").val(e.userId);d("#deleteUserModal").modal();Hg.refRepeatSubmit("deleteUserForm")}else{alert("请选择要删除的行")}});d("#deleteUserForm [tag=delete]").click(function(){var f=d(this);f.addClass("disabled").removeClass("btn-primary");var e=d("#deleteUserForm").serializeArray();d.ajax({type:"POST",url:G_CTX_PATH+"/manage/role/deleteUser",data:e,success:function(g,i,h){if(g.success){ui_alert("删除成功",function(){d("#deleteUserModal").modal("hide");c()})}else{ajaxExceptionHandler(h,function(){Hg.refreshSubmitToken("deleteUserForm");ui_error(g.data);c()})}},complete:function(g,h){f.addClass("btn-primary").removeClass("disabled")}})});d("#updateSysUserBtn").on("click",function(){var g=jQuery("#grid-table").jqGrid("getGridParam","selrow");if(g){var e=jQuery("#grid-table").jqGrid("getRowData",g);if(e.userId){var f={userId:e.userId};d.ajax({type:"POST",url:G_CTX_PATH+"/manage/role/getUserById",data:f,success:function(h,j,i){if(h.success){d("#updateUserModal").modal();Hg.refRepeatSubmit("updateUserForm");d("#newuserId").val(h.sysuser.userId);d("#newloginName").val(h.sysuser.loginName);d("#newuserName").val(h.sysuser.userName);d("#newengName").val(h.sysuser.engName);d("#newsex").val(h.sysuser.sex);d("#newbirthday").val(h.sysuser.birthday);d("#newmobile").val(h.sysuser.mobile);d("#newtelephone").val(h.sysuser.telephone);d("#newemail").val(h.sysuser.email);d("#newaddress").val(h.sysuser.address);d("#newcheckedRoleIds").val(h.sysuser.authIds)}else{ajaxExceptionHandler(i,function(){Hg.refreshSubmitToken("updateUserForm");ui_error(h.data);c()})}},complete:function(h,i){}})}}else{alert("请选择要修改的行")}});d("#updateUserForm").validate({rules:{userName:{required:true,verifyName:true},mobile:{required:true,isMobile:true}}});d("#updateUserForm [tag=update]").click(function(){if(!d("#updateUserForm").validate().form()){return false}var f=d(this);f.addClass("disabled").removeClass("btn-primary");var e=d("#updateUserForm").serializeArray();d.ajax({type:"POST",url:G_CTX_PATH+"/manage/role/updateUser",data:e,success:function(g,i,h){if(g.success){ui_alert("修改成功",function(){d("#updateUserModal").modal("hide");c()})}else{ajaxExceptionHandler(h,function(){Hg.refreshSubmitToken("updateUserForm");ui_error(g.data)})}},complete:function(g,h){f.addClass("btn-primary").removeClass("disabled")}})});d("#updateSysUserPwdBtn").on("click",function(){var f=jQuery("#grid-table").jqGrid("getGridParam","selrow");if(f){var e=jQuery("#grid-table").jqGrid("getRowData",f);d("#newpwduserId").val(e.userId);d("#updateUserPwdModal").modal();Hg.refRepeatSubmit("updateUserPwdForm")}else{alert("请选择要修改的行")}});d("#updateUserPwdForm").validate({rules:{plainPassword:{required:true,isPassword:true}}});d("#updateUserPwdForm [tag=updatepwd]").click(function(){if(!d("#updateUserPwdForm").validate().form()){return false}var g=d("#newplainPassword").val();var e=d("#new2plainPassword").val();if(g!=e){alert("密码不一致!");return}var h=d(this);h.addClass("disabled").removeClass("btn-primary");var f=d("#updateUserPwdForm").serializeArray();d.ajax({type:"POST",url:G_CTX_PATH+"/manage/role/updatePwdUser",data:f,success:function(i,k,j){if(i.success){ui_alert("修改密码成功",function(){d("#updateUserPwdModal").modal("hide")})}else{ajaxExceptionHandler(j,function(){Hg.refreshSubmitToken("updateUserPwdForm");ui_error(i.data)})}},complete:function(i,j){h.addClass("btn-primary").removeClass("disabled")}})})});