jQuery(function(b){var d="#grid-table";var h="#grid-pager";jQuery(d).jqGrid({url:G_CTX_PATH+"/manage/role/sysroletables",datatype:"json",mtype:"GET",width:"300",height:"320",colNames:["角色id","角色名称","不可修改","角色状态"],colModel:[{name:"roleId",index:"roleId",width:8,sortable:false,hidden:true},{name:"roleName",index:"roleName",width:8,sortable:false},{name:"isFinalStr",index:"isFinalStr",width:25,sortable:false},{name:"isDelete",index:"isDelete",width:8,sortable:false,formatter:i}],jsonReader:{root:"rows",total:function(l){var k=l.total;var m=parseInt(b("#grid-table").getGridParam("rowNum"));return k%m>0?k/m+1:k/m},page:"page",records:"total",repeatitems:false},postData:{},viewrecords:true,rowNum:10,rowList:[10,20,30],pager:h,altRows:true,multiboxonly:true,loadComplete:function(){var k=this;setTimeout(function(){updatePagerIcons(k)},0)},autowidth:true});function i(k,l,n){var m="正常";if(k==1){m="删除"}return m}function f(){b("#grid-table").jqGrid("setGridParam",{page:1});b("#grid-table").jqGrid("setGridParam",{postData:{roleName:b("#roleName").val(),},datatype:"json"}).trigger("reloadGrid")}b("#manageroleSearchBtn").on("click",function(){f()});var e=[];var a=null;b("#addSysRoleBtn").on("click",function(){Hg.getJson("/sys/role/show/0/add",{},function(k){if(k.success){Hg.getJson("/sys/role/authList",{roleId:0},function(l){e=l.list;j("tree1")});b("#addRoleForm")[0].reset();b("#addRoleModal").modal();Hg.refRepeatSubmit("addRoleForm")}else{Hg.refreshSubmitToken("addRoleForm");ui_error(k.data.substring(32,39))}})});function g(l){for(var k=0;k<e.length;k++){if(e[k].authId==l){return true}else{continue}}return false}function j(l){var k=[];Hg.getJson("/sys/auth/list",{merchantApp:9},function(n){datas=n.rows;for(var m=0;m<datas.length;m++){if(g(datas[m].authId)){if(datas[m].fid==0){k.push({authId:datas[m].authId,authName:datas[m].authName,fid:datas[m].fid,isExpand:true,ischecked:true})}else{k.push({authId:datas[m].authId,authName:datas[m].authName,fid:datas[m].fid,isExpand:false,ischecked:true})}}else{if(datas[m].fid==0){k.push({authId:datas[m].authId,authName:datas[m].authName,fid:datas[m].fid,isExpand:true})}else{k.push({authId:datas[m].authId,authName:datas[m].authName,fid:datas[m].fid,isExpand:false})}}}b("#"+l).ligerTree({data:k,idFieldName:"authId",textFieldName:"authName",parentIDFieldName:"fid"});a=b("#"+l).ligerGetTreeManager()})}function c(){var l=a.getChecked();var m="";for(var k=0;k<l.length;k++){m+=l[k].data.authId+","}return m}b.validator.addMethod("rolename",function(m,k){var l=/^[a-zA-Z\u4e00-\u9fa5]{2,20}$/;return this.optional(k)||l.test(m)},"输入2~20位英文或中文姓名！");b.validator.addMethod("rolecode",function(m,k){var l=/[A-Za-z0-9_]{4,10}/;return this.optional(k)||l.test(m)},"请输入4-10位字母、数字 _ 组成的字符串！");b("#addRoleForm").validate({rules:{roleName:{required:true,rolename:true}}});b("#addRoleForm [tag=save]").click(function(){if(!b("#addRoleForm").validate().form()){return false}var l=c();b("#checkedAuthIds").val(l);var m=b(this);m.addClass("disabled").removeClass("btn-primary");var k=b("#addRoleForm").serializeArray();b.ajax({type:"POST",url:G_CTX_PATH+"/sys/role/add",data:k,success:function(n,p,o){if(n.success){ui_alert("保存成功",function(){b("#addRoleModal").modal("hide");f()})}else{ajaxExceptionHandler(o,function(){Hg.refreshSubmitToken("addRoleForm");ui_error(n.data)})}},complete:function(n,o){m.addClass("btn-primary").removeClass("disabled")}})});b("#deleteSysRoleBtn").on("click",function(){var l=jQuery("#grid-table").jqGrid("getGridParam","selrow");if(l){var k=jQuery("#grid-table").jqGrid("getRowData",l);b("#deleteRoleName").html("确认删除角色【"+k.roleName+"】吗？");b("#deleteRoleId").val(k.roleId);b("#deleteRoleModal").modal();Hg.refRepeatSubmit("deleteRoleForm")}else{alert("请选择要删除的行")}});b("#deleteRoleForm [tag=delete]").click(function(){var l=b(this);l.addClass("disabled").removeClass("btn-primary");var k=b("#deleteRoleForm").serializeArray();b.ajax({type:"POST",url:G_CTX_PATH+"/sys/role/delete",data:k,success:function(m,o,n){if(m.success){ui_alert("删除成功",function(){b("#deleteRoleModal").modal("hide");f()})}else{ajaxExceptionHandler(n,function(){Hg.refreshSubmitToken("deleteRoleForm");ui_error(m.data);f()})}},complete:function(m,n){l.addClass("btn-primary").removeClass("disabled")}})});b("#updateSysRoleBtn").on("click",function(){var m=jQuery("#grid-table").jqGrid("getGridParam","selrow");if(m){var k=jQuery("#grid-table").jqGrid("getRowData",m);if(k.roleId){var l={roleId:k.roleId};b.ajax({type:"POST",url:G_CTX_PATH+"/sys/role/show/"+k.roleId+"/edit",data:l,success:function(n,p,o){if(n.success){Hg.getJson("/sys/role/authList",{roleId:n.sysRole.roleId},function(q){e=q.list;j("tree2")});b("#updateRoleModal").modal();Hg.refRepeatSubmit("updateRoleForm");b("#newroleId").val(n.sysRole.roleId);b("#newroleName").val(n.sysRole.roleName);b("#newdescr").val(n.sysRole.descr)}else{ajaxExceptionHandler(o,function(){Hg.refreshSubmitToken("updateRoleForm");ui_error(n.data);f()})}},complete:function(n,o){}})}}else{alert("请选择要修改的行")}});b("#updateRoleForm").validate({rules:{roleName:{required:true,rolename:true}}});b("#updateRoleForm [tag=update]").click(function(){if(!b("#updateRoleForm").validate().form()){return false}var l=c();b("#newcheckedAuthIds").val(l);var m=b(this);m.addClass("disabled").removeClass("btn-primary");var k=b("#updateRoleForm").serializeArray();b.ajax({type:"POST",url:G_CTX_PATH+"/sys/role/edit",data:k,success:function(n,p,o){if(n.success){ui_alert("修改成功",function(){b("#updateRoleModal").modal("hide");f()})}else{ajaxExceptionHandler(o,function(){Hg.refreshSubmitToken("updateRoleForm");ui_error(n.data)})}},complete:function(n,o){m.addClass("btn-primary").removeClass("disabled")}})})});