define("echarts/chart/funnel",["require","./base","zrender/shape/Text","zrender/shape/Line","zrender/shape/Polygon","../config","../util/ecData","../util/number","zrender/tool/util","zrender/tool/color","zrender/tool/area","../chart"],function(q){function v(l,i,r,h,m){k.call(this,l,i,r,h,m),this.refresh(h)}var k=q("./base"),d=q("zrender/shape/Text"),u=q("zrender/shape/Line"),c=q("zrender/shape/Polygon"),b=q("../config");b.funnel={zlevel:0,z:2,clickable:!0,legendHoverLink:!0,x:80,y:60,x2:80,y2:60,min:0,max:100,minSize:"0%",maxSize:"100%",sort:"descending",gap:0,funnelAlign:"center",itemStyle:{normal:{borderColor:"#fff",borderWidth:1,label:{show:!0,position:"outer"},labelLine:{show:!0,length:10,lineStyle:{width:1,type:"solid"}}},emphasis:{borderColor:"rgba(0,0,0,0)",borderWidth:1,label:{show:!0},labelLine:{show:!0}}}};var w=q("../util/ecData"),j=q("../util/number"),p=q("zrender/tool/util"),g=q("zrender/tool/color"),f=q("zrender/tool/area");return v.prototype={type:b.CHART_TYPE_FUNNEL,_buildShape:function(){var o=this.series,m=this.component.legend;this._paramsMap={},this._selected={},this.selectedMap={};for(var l,r=0,h=o.length;h>r;r++){if(o[r].type===b.CHART_TYPE_FUNNEL){if(o[r]=this.reformOption(o[r]),this.legendHoverLink=o[r].legendHoverLink||this.legendHoverLink,l=o[r].name||"",this.selectedMap[l]=m?m.isSelected(l):!0,!this.selectedMap[l]){continue}this._buildSingleFunnel(r),this.buildMark(r)}}this.addShapeList()},_buildSingleFunnel:function(P){var D=this.component.legend,L=this.series[P],I=this._mapData(P),T=this._getLocation(P);this._paramsMap[P]={location:T,data:I};for(var H,F=0,E=[],M=0,J=I.length;J>M;M++){H=I[M].name,this.selectedMap[H]=D?D.isSelected(H):!0,this.selectedMap[H]&&!isNaN(I[M].value)&&(E.push(I[M]),F++)}if(0!==F){for(var l,z,Q,G,R=this._buildFunnelCase(P),C=L.funnelAlign,A=L.gap,N=F>1?(T.height-(F-1)*A)/F:T.height,S=T.y,O="descending"===L.sort?this._getItemWidth(P,E[0].value):j.parsePercent(L.minSize,T.width),K="descending"===L.sort?1:0,W=T.centerX,B=[],M=0,J=E.length;J>M;M++){if(H=E[M].name,this.selectedMap[H]&&!isNaN(E[M].value)){switch(l=J-2>=M?this._getItemWidth(P,E[M+K].value):"descending"===L.sort?j.parsePercent(L.minSize,T.width):j.parsePercent(L.maxSize,T.width),C){case"left":z=T.x;break;case"right":z=T.x+T.width-O;break;default:z=W-O/2}Q=this._buildItem(P,E[M]._index,D?D.getColor(H):this.zr.getColor(E[M]._index),z,S,O,l,N,C),S+=N+A,G=Q.style.pointList,B.unshift([G[0][0]-10,G[0][1]]),B.push([G[1][0]+10,G[1][1]]),0===M&&(0===O?(G=B.pop(),"center"==C&&(B[0][0]+=10),"right"==C&&(B[0][0]=G[0]),B[0][1]-="center"==C?10:15,1==J&&(G=Q.style.pointList)):(B[B.length-1][1]-=5,B[0][1]-=5)),O=l}}R&&(B.unshift([G[3][0]-10,G[3][1]]),B.push([G[2][0]+10,G[2][1]]),0===O?(G=B.pop(),"center"==C&&(B[0][0]+=10),"right"==C&&(B[0][0]=G[0]),B[0][1]+="center"==C?10:15):(B[B.length-1][1]+=5,B[0][1]+=5),R.style.pointList=B)}},_buildFunnelCase:function(o){var m=this.series[o];if(this.deepQuery([m,this.option],"calculable")){var l=this._paramsMap[o].location,r=10,h={hoverable:!1,style:{pointListd:[[l.x-r,l.y-r],[l.x+l.width+r,l.y-r],[l.x+l.width+r,l.y+l.height+r],[l.x-r,l.y+l.height+r]],brushType:"stroke",lineWidth:1,strokeColor:m.calculableHolderColor||this.ecTheme.calculableHolderColor||b.calculableHolderColor}};return w.pack(h,m,o,void 0,-1),this.setCalculable(h),h=new c(h),this.shapeList.push(h),h}},_getLocation:function(x){var m=this.series[x],l=this.zr.getWidth(),z=this.zr.getHeight(),h=this.parsePercent(m.x,l),y=this.parsePercent(m.y,z),s=null==m.width?l-h-this.parsePercent(m.x2,l):this.parsePercent(m.width,l);return{x:h,y:y,width:s,height:null==m.height?z-y-this.parsePercent(m.y2,z):this.parsePercent(m.height,z),centerX:h+s/2}},_mapData:function(x){function m(i,a){return"-"===i.value?1:"-"===a.value?-1:a.value-i.value}function l(n,a){return -m(n,a)}for(var z=this.series[x],h=p.clone(z.data),y=0,s=h.length;s>y;y++){h[y]._index=y}return"none"!=z.sort&&h.sort("descending"===z.sort?m:l),h},_buildItem:function(H,N,F,A,L,z,s,E,G){var C=this.series,B=C[H],D=B.data[N],I=this.getPolygon(H,N,F,A,L,z,s,E,G);w.pack(I,C[H],H,C[H].data[N],N,C[H].data[N].name),this.shapeList.push(I);var x=this.getLabel(H,N,F,A,L,z,s,E,G);w.pack(x,C[H],H,C[H].data[N],N,C[H].data[N].name),this.shapeList.push(x),this._needLabel(B,D,!1)||(x.invisible=!0);var J=this.getLabelLine(H,N,F,A,L,z,s,E,G);this.shapeList.push(J),this._needLabelLine(B,D,!1)||(J.invisible=!0);var M=[],K=[];return this._needLabelLine(B,D,!0)&&(M.push(J.id),K.push(J.id)),this._needLabel(B,D,!0)&&(M.push(x.id),K.push(I.id)),I.hoverConnect=M,x.hoverConnect=K,I},_getItemWidth:function(z,m){var l=this.series[z],B=this._paramsMap[z].location,h=l.min,A=l.max,y=j.parsePercent(l.minSize,B.width),x=j.parsePercent(l.maxSize,B.width);return(m-h)*(x-y)/(A-h)+y},getPolygon:function(J,A,G,E,N,C,B,F,H){var m,o=this.series[J],K=o.data[A],D=[K,o],L=this.deepMerge(D,"itemStyle.normal")||{},z=this.deepMerge(D,"itemStyle.emphasis")||{},x=this.getItemStyleColor(L.color,J,A,K)||G,I=this.getItemStyleColor(z.color,J,A,K)||("string"==typeof x?g.lift(x,-0.2):x);switch(H){case"left":m=E;break;case"right":m=E+(C-B);break;default:m=E+(C-B)/2}var M={zlevel:o.zlevel,z:o.z,clickable:this.deepQuery(D,"clickable"),style:{pointList:[[E,N],[E+C,N],[m+B,N+F],[m,N+F]],brushType:"both",color:x,lineWidth:L.borderWidth,strokeColor:L.borderColor},highlightStyle:{color:I,lineWidth:z.borderWidth,strokeColor:z.borderColor}};return this.deepQuery([K,o,this.option],"calculable")&&(this.setCalculable(M),M.draggable=!0),new c(M)},getLabel:function(N,C,J,R,G,E,D,H,m){var O,F=this.series[N],P=F.data[C],B=this._paramsMap[N].location,z=p.merge(p.clone(P.itemStyle)||{},F.itemStyle),K="normal",Q=z[K].label,M=Q.textStyle||{},I=z[K].labelLine.length,S=this.getLabelText(N,C,K),A=this.getFont(M),n=J;Q.position=Q.position||z.normal.label.position,"inner"===Q.position||"inside"===Q.position||"center"===Q.position?(O=m,n=Math.max(E,D)/2>f.getTextWidth(S,A)?"#fff":g.reverse(J)):O="left"===Q.position?"right":"left";var h={zlevel:F.zlevel,z:F.z+1,style:{x:this._getLabelPoint(Q.position,R,B,E,D,I,m),y:G+H/2,color:M.color||n,text:S,textAlign:M.align||O,textBaseline:M.baseline||"middle",textFont:A}};return K="emphasis",Q=z[K].label||Q,M=Q.textStyle||M,I=z[K].labelLine.length||I,Q.position=Q.position||z.normal.label.position,S=this.getLabelText(N,C,K),A=this.getFont(M),n=J,"inner"===Q.position||"inside"===Q.position||"center"===Q.position?(O=m,n=Math.max(E,D)/2>f.getTextWidth(S,A)?"#fff":g.reverse(J)):O="left"===Q.position?"right":"left",h.highlightStyle={x:this._getLabelPoint(Q.position,R,B,E,D,I,m),color:M.color||n,text:S,textAlign:M.align||O,textFont:A,brushType:"fill"},new d(h)},getLabelText:function(x,m,l){var z=this.series,h=z[x],y=h.data[m],s=this.deepQuery([y,h],"itemStyle."+l+".label.formatter");return s?"function"==typeof s?s.call(this.myChart,{seriesIndex:x,seriesName:h.name||"",series:h,dataIndex:m,data:y,name:y.name,value:y.value}):"string"==typeof s?s=s.replace("{a}","{a0}").replace("{b}","{b0}").replace("{c}","{c0}").replace("{a0}",h.name).replace("{b0}",y.name).replace("{c0}",y.value):void 0:y.name},getLabelLine:function(L,A,I,F,E,C,B,H,G){var a=this.series[L],h=a.data[A],M=this._paramsMap[L].location,D=p.merge(p.clone(h.itemStyle)||{},a.itemStyle),N="normal",z=D[N].labelLine,x=D[N].labelLine.length,J=z.lineStyle||{},O=D[N].label;O.position=O.position||D.normal.label.position;var K={zlevel:a.zlevel,z:a.z+1,hoverable:!1,style:{xStart:this._getLabelLineStartPoint(F,M,C,B,G),yStart:E+H/2,xEnd:this._getLabelPoint(O.position,F,M,C,B,x,G),yEnd:E+H/2,strokeColor:J.color||I,lineType:J.type,lineWidth:J.width}};return N="emphasis",z=D[N].labelLine||z,x=D[N].labelLine.length||x,J=z.lineStyle||J,O=D[N].label||O,O.position=O.position,K.highlightStyle={xEnd:this._getLabelPoint(O.position,F,M,C,B,x,G),strokeColor:J.color||I,lineType:J.type,lineWidth:J.width},new u(K)},_getLabelPoint:function(x,m,l,z,h,y,s){switch(x="inner"===x||"inside"===x?"center":x){case"center":return"center"==s?m+z/2:"left"==s?m+10:m+z-10;case"left":return"auto"===y?l.x-10:"center"==s?l.centerX-Math.max(z,h)/2-y:"right"==s?m-(h>z?h-z:0)-y:l.x-y;default:return"auto"===y?l.x+l.width+10:"center"==s?l.centerX+Math.max(z,h)/2+y:"right"==s?l.x+l.width+y:m+Math.max(z,h)+y}},_getLabelLineStartPoint:function(o,m,l,r,h){return"center"==h?m.centerX:r>l?o+Math.min(l,r)/2:o+Math.max(l,r)/2},_needLabel:function(l,h,a){return this.deepQuery([h,l],"itemStyle."+(a?"emphasis":"normal")+".label.show")},_needLabelLine:function(l,h,a){return this.deepQuery([h,l],"itemStyle."+(a?"emphasis":"normal")+".labelLine.show")},refresh:function(a){a&&(this.option=a,this.series=a.series),this.backupShapeList(),this._buildShape()}},p.inherits(v,k),q("../chart").define("funnel",v),v});