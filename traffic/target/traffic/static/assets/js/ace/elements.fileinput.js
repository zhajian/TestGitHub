(function(h,e){var f="multiple" in document.createElement("INPUT");var o="FileList" in window;var d="FileReader" in window;var m="File" in window;var i=function(s,t){var p=this;this.settings=h.extend({},h.fn.ace_file_input.defaults,t);this.$element=h(s);this.element=s;this.disabled=false;this.can_reset=true;this.$element.off("change.ace_inner_call").on("change.ace_inner_call",function(v,u){if(p.disabled){return}if(u===true){return}return c.call(p)});var q=this.$element.closest("label").css({display:"block"});var r=q.length==0?"label":"span";this.$element.wrap("<"+r+' class="ace-file-input" />');this.apply_settings();this.reset_input_field()};i.error={FILE_LOAD_FAILED:1,IMAGE_LOAD_FAILED:2,THUMBNAIL_FAILED:3};i.prototype.apply_settings=function(){var q=this;this.multi=this.$element.attr("multiple")&&f;this.well_style=this.settings.style=="well";if(this.well_style){this.$element.parent().addClass("ace-file-multiple")}else{this.$element.parent().removeClass("ace-file-multiple")}this.$element.parent().find(":not(input[type=file])").remove();this.$element.after('<span class="ace-file-container" data-title="'+this.settings.btn_choose+'"><span class="ace-file-name" data-title="'+this.settings.no_file+'">'+(this.settings.no_icon?'<i class="'+ace.vars.icon+this.settings.no_icon+'"></i>':"")+"</span></span>");this.$label=this.$element.next();this.$container=this.$element.closest(".ace-file-input");var p=!!this.settings.icon_remove;if(p){var r=h('<a class="remove" href="#"><i class="'+ace.vars.icon+this.settings.icon_remove+'"></i></a>').appendTo(this.$element.parent());r.on(ace.click_event,function(u){u.preventDefault();if(!q.can_reset){return false}var s=true;if(q.settings.before_remove){s=q.settings.before_remove.call(q.element)}if(!s){return false}var t=q.reset_input();return false})}if(this.settings.droppable&&o){j.call(this)}};i.prototype.show_file_list=function(q,v){var s=typeof q==="undefined"?this.$element.data("ace_input_files"):q;if(!s||s.length==0){return}if(this.well_style){this.$label.find(".ace-file-name").remove();if(!this.settings.btn_change){this.$label.addClass("hide-placeholder")}}this.$label.attr("data-title",this.settings.btn_change).addClass("selected");for(var u=0;u<s.length;u++){var r="",z=false;if(typeof s[u]==="string"){r=s[u]}else{if(m&&s[u] instanceof File){r=h.trim(s[u].name)}else{if(s[u] instanceof Object&&s[u].hasOwnProperty("name")){r=s[u].name;if(s[u].hasOwnProperty("type")){z=s[u].type}if(!s[u].hasOwnProperty("path")){s[u].path=s[u].name}}else{continue}}}var x=r.lastIndexOf("\\")+1;if(x==0){x=r.lastIndexOf("/")+1}r=r.substr(x);if(z==false){if((/\.(jpe?g|png|gif|svg|bmp|tiff?)$/i).test(r)){z="image"}else{if((/\.(mpe?g|flv|mov|avi|swf|mp4|mkv|webm|wmv|3gp)$/i).test(r)){z="video"}else{if((/\.(mp3|ogg|wav|wma|amr|aac)$/i).test(r)){z="audio"}else{z="file"}}}}var w={file:"fa fa-file",image:"fa fa-picture-o file-image",video:"fa fa-film file-video",audio:"fa fa-music file-audio"};var p=w[z];if(!this.well_style){this.$label.find(".ace-file-name").attr({"data-title":r}).find(ace.vars[".icon"]).attr("class",ace.vars.icon+p)}else{this.$label.append('<span class="ace-file-name" data-title="'+r+'"><i class="'+ace.vars.icon+p+'"></i></span>');var y=(v===true&&m&&s[u] instanceof File)?h.trim(s[u].type):"";var t=d&&this.settings.thumbnail&&((y.length>0&&y.match("image"))||(y.length==0&&z=="image"));if(t){var A=this;h.when(n.call(this,s[u])).fail(function(B){if(A.settings.preview_error){A.settings.preview_error.call(A,r,B.code)}})}}}return true};i.prototype.reset_input=function(){this.reset_input_ui();this.reset_input_field()};i.prototype.reset_input_ui=function(){this.$label.attr({"data-title":this.settings.btn_choose,"class":"ace-file-container"}).find(".ace-file-name:first").attr({"data-title":this.settings.no_file,"class":"ace-file-name"}).find(ace.vars[".icon"]).attr("class",ace.vars.icon+this.settings.no_icon).prev("img").remove();if(!this.settings.no_icon){this.$label.find(ace.vars[".icon"]).remove()}this.$label.find(".ace-file-name").not(":first").remove();this.reset_input_data()};i.prototype.reset_input_field=function(){this.$element.wrap("<form>").parent().get(0).reset();this.$element.unwrap()};i.prototype.reset_input_data=function(){if(this.$element.data("ace_input_files")){this.$element.removeData("ace_input_files");this.$element.removeData("ace_input_method")}};i.prototype.enable_reset=function(p){this.can_reset=p};i.prototype.disable=function(){this.disabled=true;this.$element.attr("disabled","disabled").addClass("disabled")};i.prototype.enable=function(){this.disabled=false;this.$element.removeAttr("disabled").removeClass("disabled")};i.prototype.files=function(){return h(this).data("ace_input_files")||null};i.prototype.method=function(){return h(this).data("ace_input_method")||""};i.prototype.update_settings=function(p){this.settings=h.extend({},this.settings,p);this.apply_settings()};i.prototype.loading=function(r){if(r===false){this.$container.find(".ace-file-overlay").remove();this.element.removeAttribute("readonly")}else{var q=typeof r==="string"?r:'<i class="overlay-content fa fa-spin fa-spinner orange2 fa-2x"></i>';var p=this.$container.find(".ace-file-overlay");if(p.length==0){p=h('<div class="ace-file-overlay"></div>').appendTo(this.$container);p.on("click tap",function(s){s.stopImmediatePropagation();s.preventDefault();return false});this.element.setAttribute("readonly","true")}p.empty().append(q)}};var j=function(){var q=this;var p=this.$element.parent();p.off("dragenter").on("dragenter",function(r){r.preventDefault();r.stopPropagation()}).off("dragover").on("dragover",function(r){r.preventDefault();r.stopPropagation()}).off("drop").on("drop",function(u){u.preventDefault();u.stopPropagation();if(q.disabled){return}var t=u.originalEvent.dataTransfer;var r=t.files;if(!q.multi&&r.length>1){var s=[];s.push(r[0]);r=s}r=b.call(q,r,true);if(r===false){return false}q.$element.data("ace_input_method","drop");q.$element.data("ace_input_files",r);q.show_file_list(r,true);q.$element.triggerHandler("change",[true]);return true})};var c=function(){var p=this.element.files||[this.element.value];p=b.call(this,p,false);if(p===false){return false}this.$element.data("ace_input_method","select");this.$element.data("ace_input_files",p);this.show_file_list(p,true);return true};var n=function(w){var t=this;var r=t.$label.find(".ace-file-name:last");var s=new h.Deferred;var v=function(y){r.prepend("<img class='middle' style='display:none;' />");var x=r.find("img:last").get(0);h(x).one("load",function(){u.call(null,x)}).one("error",function(){q.call(null,x)});x.src=y};var u=function(z){var A=50;if(t.settings.thumbnail=="large"){A=150}else{if(t.settings.thumbnail=="fit"){A=r.width()}}r.addClass(A>50?"large":"");var y=k(z,A);if(y==null){h(this).remove();s.reject({code:i.error.THUMBNAIL_FAILED});return}var x=y.w,B=y.h;if(t.settings.thumbnail=="small"){x=B=A}h(z).css({"background-image":"url("+y.src+")",width:x,height:B}).data("thumb",y.src).attr({src:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="}).show();s.resolve()};var q=function(x){r.find("img").remove();s.reject({code:i.error.IMAGE_LOAD_FAILED})};if(m&&w instanceof File){var p=new FileReader();p.onload=function(x){v(x.target.result)};p.onerror=function(x){s.reject({code:i.error.FILE_LOAD_FAILED})};p.readAsDataURL(w)}else{if(w instanceof Object&&w.hasOwnProperty("path")){v(w.path)}}return s.promise()};var k=function(s,y,v){var x=s.width,t=s.height;x=x>0?x:h(s).width();t=t>0?t:h(s).height();if(x>y||t>y){if(x>t){t=parseInt(y/x*t);x=y}else{x=parseInt(y/t*x);t=y}}var r;try{var q=document.createElement("canvas");q.width=x;q.height=t;var p=q.getContext("2d");p.drawImage(s,0,0,s.width,s.height,0,0,x,t);r=q.toDataURL()}catch(u){r=null}if(!r){return null}if(!(/^data\:image\/(png|jpe?g|gif);base64,[0-9A-Za-z\+\/\=]+$/.test(r))){r=null}if(!r){return null}return{src:r,w:x,h:t}};var b=function(q,r){var p=a.call(this,q,r);if(p===-1){this.reset_input();return false}if(!p||p.length==0){if(!this.$element.data("ace_input_files")){this.reset_input()}return false}if(p instanceof Array||(o&&p instanceof FileList)){q=p}p=true;if(this.settings.before_change){p=this.settings.before_change.call(this.element,q,r)}if(p===-1){this.reset_input();return false}if(!p||p.length==0){if(!this.$element.data("ace_input_files")){this.reset_input()}return false}if(p instanceof Array||(o&&p instanceof FileList)){q=p}return q};var l=function(p){if(!p){return null}if(typeof p==="string"){p=[p]}if(p.length==0){return null}return new RegExp(".(?:"+p.join("|")+")$","i")};var g=function(p){if(!p){return null}if(typeof p==="string"){p=[p]}if(p.length==0){return null}return new RegExp("^(?:"+p.join("|").replace(/\//g,"\\/")+")$","i")};var a=function(r,s){var A=l(this.settings.allowExt);var u=l(this.settings.denyExt);var w=g(this.settings.allowMime);var x=g(this.settings.denyMime);var C=this.settings.maxSize||false;if(!(A||u||w||x||C)){return true}var D=[];var B={};for(var y=0;y<r.length;y++){var t=r[y];var p=!m?t:t.name;if(A&&!A.test(p)){if(!("ext" in B)){B.ext=[]}B.ext.push(p);continue}else{if(u&&u.test(p)){if(!("ext" in B)){B.ext=[]}B.ext.push(p);continue}}var z;if(!m){D.push(t);continue}else{if((z=h.trim(t.type)).length>0){if(w&&!w.test(z)){if(!("mime" in B)){B.mime=[]}B.mime.push(p);continue}else{if(x&&x.test(z)){if(!("mime" in B)){B.mime=[]}B.mime.push(p);continue}}}}if(C&&t.size>C){if(!("size" in B)){B.size=[]}B.size.push(p);continue}D.push(t)}if(D.length==r.length){return r}var v={ext:0,mime:0,size:0};if("ext" in B){v.ext=B.ext.length}if("mime" in B){v.mime=B.mime.length}if("size" in B){v.size=B.size.length}var q;this.$element.trigger(q=new h.Event("file.error.ace"),{file_count:r.length,invalid_count:r.length-D.length,error_list:B,error_count:v,dropped:s});if(q.isDefaultPrevented()){return -1}return D};h.fn.aceFileInput=h.fn.ace_file_input=function(r,s){var q;var p=this.each(function(){var v=h(this);var u=v.data("ace_file_input");var t=typeof r==="object"&&r;if(!u){v.data("ace_file_input",(u=new i(this,t)))}if(typeof r==="string"){q=u[r](s)}});return(q===e)?p:q};h.fn.aceFileInput.defaults=h.fn.ace_file_input.defaults={style:false,no_file:"No File ...",no_icon:"fa fa-upload",btn_choose:"Choose",btn_change:"Change",icon_remove:"fa fa-times",droppable:false,thumbnail:false,allowExt:null,denyExt:null,allowMime:null,denyMime:null,maxSize:false,before_change:null,before_remove:null,preview_error:null}})(window.jQuery);