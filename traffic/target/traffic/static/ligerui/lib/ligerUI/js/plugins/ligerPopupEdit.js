(function(a){a.fn.ligerPopupEdit=function(b){return a.ligerui.run.call(this,"ligerPopupEdit",arguments)};a.fn.ligerGetPopupEditManager=function(){return a.ligerui.run.call(this,"ligerGetPopupEditManager",arguments)};a.ligerDefaults.PopupEdit={valueFieldID:null,css:null,onButtonClick:null,nullText:null,disabled:false,cancelable:true,width:200,heigth:null,render:null,split:";",grid:null,condition:null,valueField:"id",textField:"text",parms:null,onSelect:null,onSelected:null,valueFieldCssClass:null};a.ligerMethos.PopupEdit=a.ligerMethos.PopupEdit||{};a.ligerui.controls.PopupEdit=function(c,b){a.ligerui.controls.PopupEdit.base.constructor.call(this,c,b)};a.ligerui.controls.PopupEdit.ligerExtend(a.ligerui.controls.Input,{__getType:function(){return"PopupEdit"},_extendMethods:function(){return a.ligerMethos.PopupEdit},_init:function(){a.ligerui.controls.PopupEdit.base._init.call(this)},_render:function(){var b=this,c=this.options;b.inputText=null;if(this.element.tagName.toLowerCase()=="input"){this.element.readOnly=true;b.inputText=a(this.element);b.textFieldID=this.element.id}if(b.inputText[0].name==undefined){b.inputText[0].name=b.textFieldID}b.valueField=null;if(c.valueFieldID){b.valueField=a("#"+c.valueFieldID+":input");if(b.valueField.length==0){b.valueField=a('<input type="hidden"/>')}b.valueField[0].id=b.valueField[0].name=c.valueFieldID}else{b.valueField=a('<input type="hidden"/>');b.valueField[0].id=b.valueField[0].name=b.textFieldID+"_val"}if(b.valueField[0].name==undefined){b.valueField[0].name=b.valueField[0].id}if(c.valueFieldCssClass){b.valueField.addClass(c.valueFieldCssClass)}b.link=a('<div class="l-trigger"><div class="l-trigger-icon"></div></div>');b.wrapper=b.inputText.wrap('<div class="l-text l-text-popup"></div>').parent();b.wrapper.append('<div class="l-text-l"></div><div class="l-text-r"></div>');b.wrapper.append(b.link);b.wrapper.append(b.valueField);b.inputText.addClass("l-text-field");b.link.hover(function(){if(c.disabled){return}this.className="l-trigger-hover"},function(){if(c.disabled){return}this.className="l-trigger"}).mousedown(function(){if(c.disabled){return}this.className="l-trigger-pressed"}).mouseup(function(){if(c.disabled){return}this.className="l-trigger-hover"}).click(function(){if(c.disabled){return}if(b.trigger("buttonClick")==false){return false}});b.inputText.click(function(){if(c.disabled){return}}).blur(function(){if(c.disabled){return}b.wrapper.removeClass("l-text-focus")}).focus(function(){if(c.disabled){return}b.wrapper.addClass("l-text-focus")});b.wrapper.hover(function(){if(c.disabled){return}b.wrapper.addClass("l-text-over")},function(){if(c.disabled){return}b.wrapper.removeClass("l-text-over")});b.set(c)},destroy:function(){if(this.wrapper){this.wrapper.remove()}this.options=null;a.ligerui.remove(this)},clear:function(){var b=this,c=this.options;b.inputText.val("");b.valueField.val("")},_setCss:function(b){if(b){this.wrapper.addClass(b)}},_setCancelable:function(c){var b=this,d=this.options;if(!c&&b.unselect){b.unselect.remove();b.unselect=null}if(!c&&!b.unselect){return}b.unselect=a('<div class="l-trigger l-trigger-cancel"><div class="l-trigger-icon"></div></div>').hide();b.wrapper.hover(function(){b.unselect.show()},function(){b.unselect.hide()});if(!d.disabled&&d.cancelable){b.wrapper.append(b.unselect)}b.unselect.hover(function(){this.className="l-trigger-hover l-trigger-cancel"},function(){this.className="l-trigger l-trigger-cancel"}).click(function(){b.clear()})},_setDisabled:function(b){if(b){this.wrapper.addClass("l-text-disabled")}else{this.wrapper.removeClass("l-text-disabled")}},_setWidth:function(c){var b=this;if(c>20){b.wrapper.css({width:c});b.inputText.css({width:c-20})}},_setHeight:function(c){var b=this;if(c>10){b.wrapper.height(c);b.inputText.height(c-2)}},getData:function(){var e=this,i=this.options;var h=[];var c=a(e.valueField).val(),d=a(e.inputText).val();var b=c?c.split(i.split):null,f=d?d.split(i.split):null;a(b).each(function(g){var j={};j[i.textField]=f[g];j[i.valueField]=b[g];h.push(j)});return h},_getText:function(){return a(this.inputText).val()},_getValue:function(){return a(this.valueField).val()},getValue:function(){return this._getValue()},getText:function(){return this._getText()},setValue:function(c,e){var b=this,d=this.options;if(arguments.length>=2){b.setValue(c);b.setText(e);return}b.valueField.val(c)},setText:function(d){var b=this,c=this.options;if(c.render){b.inputText.val(c.render(d))}else{b.inputText.val(d)}},addValue:function(k,n){var j=this,c=this.options;if(!k){return}var m=j.getValue(),o=j.getText();if(!m){j.setValue(k);j.setText(n)}else{var b=[],d=[],e=m.split(c.split),k=k.split(c.split),n=n.split(c.split);for(var h=0,f=k.length;h<f;h++){if(a.inArray(k[h],e)==-1){b.push(k[h]);d.push(n[h])}}if(b.length){j.setValue(m+c.split+b.join(c.split));j.setText(o+c.split+d.join(c.split))}}},removeValue:function(j,m){var f=this,c=this.options;if(!j){return}var k=f.getValue(),n=f.getText();if(!k){return}var o=k.split(c.split),b=n.split(c.split),j=j.split(c.split);for(var e=0,h=-1,d=j.length;e<d;e++){if((h=a.inArray(j[e],o))!=-1){o.splice(h,1);b.splice(h,1)}}f.setValue(o.join(c.split));f.setText(b.join(c.split))},_setGrid:function(c){if(!c){return}var b=this,e=this.options;var d=a.extend({parms:e.parms},e.grid);this.bind("buttonClick",function(){if(!b.popupFn){var f={grid:d,condition:e.condition,valueField:e.valueField,textField:e.textField,split:e.split,lastSelected:b.getData(),onSelect:function(g){if(b.trigger("select",g)==false){return}if(e.grid.checkbox){b.addValue(g.value,g.text);b.removeValue(g.remvoeValue,g.remvoeText)}else{b.setValue(g.value);b.setText(g.text)}b.trigger("selected",g)},selectInit:function(h){var g=b.getValue();if(!g){return false}if(!e.valueField||!h[e.valueField]){return false}return a.inArray(h[e.valueField].toString(),g.split(e.split))!=-1}};b.popupFn=a.ligerui.getPopupFn(f)}b.popupFn()})}});a.ligerui.getPopupFn=function(h){h=a.extend({title:"选择数据",width:700,height:320,top:null,left:null,split:";",valueField:null,textField:null,grid:null,condition:null,onSelect:function(j){},selectInit:function(j){return false}},h);if(!h.grid){return}var g,c,i,f=h.lastSelected||[];return function(){b();return false};function b(){function m(q){q=q||h.height;q-=o.height();return q}if(g){c._showData();g.show();c.refreshSize();f=c.selected.concat();return}var l=a("<div></div>");var o=a("<div></div>");var n=a("<div></div>");l.append(o).append(n);if(h.condition){var k=a.extend({labelWidth:60,space:20},h.condition);i=o.ligerForm(k)}else{o.remove()}var p=a.extend({columnWidth:120,alternatingRow:false,frozen:true,rownumbers:true},h.grid,{width:"100%",height:m(),isChecked:h.selectInit,isSelected:h.selectInit,inWindow:false});c=n.ligerGrid(p);if(h.condition){var j=a('<li style="margin-right:9px"><div></div></li>');a("ul:first",o).append(j).after('<div class="l-clear"></div>');a("div",j).ligerButton({text:"搜索",click:function(){var q=a.ligerui.getConditions(o);c.setParm("condition",a.ligerui.toJSON(q));c.reload()}})}g=a.ligerDialog.open({title:h.title,width:h.width,height:"auto",top:h.top,left:h.left,target:l,isResize:true,cls:"l-selectorwin",onContentHeightChange:function(q){c.set("height",m(q));return false},onStopResize:function(){c.refreshSize()},buttons:[{text:"选择",onclick:function(r,q){d();q.hide()}},{text:"取消",onclick:function(r,q){q.hide()}}]});c.refreshSize()}function e(m,l){for(var j=0;l&&l[j];j++){var k=l[j];if(k[h.valueField]==m){return true}}return false}function d(){var l=c.selected||[];var n=[],p=[],m=[];a(l).each(function(r,t){h.valueField&&n.push(t[h.valueField]);h.textField&&p.push(t[h.textField]);var s=a.extend(true,{},this);c.formatRecord(s,true);m.push(s)});var k=[];a(f).each(function(r,s){if(!e(s[h.valueField],l)&&e(s[h.valueField],c.rows)){k.push(s)}});var o=[],j=[],q=[];a(k).each(function(r,t){h.valueField&&o.push(t[h.valueField]);h.textField&&j.push(t[h.textField]);var s=a.extend(true,{},this);c.formatRecord(s,true);q.push(s)});h.onSelect({value:n.join(h.split),text:p.join(h.split),data:m,remvoeValue:o.join(h.split),remvoeText:j.join(h.split),removeData:q})}}})(jQuery);