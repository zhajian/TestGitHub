(function(a){a.fn.ligerPortal=function(b){return a.ligerui.run.call(this,"ligerPortal",arguments)};a.ligerDefaults.Portal={width:null,rows:null,columns:null,url:null,method:"get",parms:null,draggable:false,onLoaded:null};a.ligerDefaults.Portal_rows={width:null,height:null};a.ligerDefaults.Portal_columns={width:null,height:null};a.ligerMethos.Portal={};a.ligerui.controls.Portal=function(c,b){a.ligerui.controls.Portal.base.constructor.call(this,c,b)};a.ligerui.controls.Portal.ligerExtend(a.ligerui.core.UIComponent,{__getType:function(){return"Portal"},__idPrev:function(){return"Portal"},_extendMethods:function(){return a.ligerMethos.Portal},_init:function(){var b=this,c=this.options;a.ligerui.controls.Portal.base._init.call(this);if(a(">div",b.element).length){c.columns=[];a(">div",b.element).each(function(d,e){c.columns[d]={panels:[]}});b.tempInitPanels=a("<div></div>");a(">div",b.element).appendTo(b.tempInitPanels)}if(!c.rows&&c.columns){c.rows=[{columns:c.columns}]}},_render:function(){var b=this,c=this.options;b.portal=a(b.element).addClass("l-portal").html("");b.set(c)},_setRows:function(d){var c=this,e=this.options;c.rows=[];if(d&&d.length){for(var b=0;b<d.length;b++){var f=d[b];var h=a('<div class="l-row"></div>').appendTo(c.portal);c.rows[b]=c._renderRow({row:f,rowIndex:b,jrow:h});h.append('<div class="l-clear"></div>')}}},_renderRow:function(j){var o=j.row,k=j.rowIndex,d=j.jrow;var h=this,b=this.options;var m={element:d[0]};if(o.width){d.width(o.width)}if(o.height){d.height(o.height)}if(o.columns){m.columns=[]}if(o.columns&&o.columns.length){for(var f=0;f<o.columns.length;f++){var c=o.columns[f];var n=a('<div class="l-column"></div>').appendTo(d);m.columns[f]=h._renderColumn({column:c,columnIndex:f,jcolumn:n,rowIndex:k})}}return m},remove:function(j){var f=this,h=this.options;var k=j.rowIndex,d=j.columnIndex,c=j.index;if(c==null){c=-1}if(c>=0&&f.rows[k]&&f.rows[k].columns&&f.rows[k].columns[d]&&f.rows[k].columns[d].panels){var b=f.rows[k].columns[d].panels[c];b&&b.close();f._updatePortal()}},add:function(m){var h=this,c=this.options;var o=m.rowIndex,n=m.columnIndex,k=m.index,b=m.panel;if(k==null){k=-1}if(!(h.rows[o]&&h.rows[o].columns&&h.rows[o].columns[n])){return}var f=h.rows[o].columns[n],d=c.rows[o].columns[n],r,q=a(f.element);d.panels=d.panels||[];f.panels=f.panels||[];d.panels.splice(k,0,b);if(k<0){var j=a("<div></div>").insertBefore(f.jplace);r=j.ligerPanel(b)}else{if(f.panels[k]){var j=a("<div></div>").insertBefore(f.panels[k].panel);r=j.ligerPanel(b)}}if(r){r.bind("closed",h._createPanelClosed());h.setPanelEvent({panel:r});f.panels.splice(k,0,r)}h._updatePortal()},_createPanelClosed:function(){var b=this,c=this.options;return function(){var d=this;var f=b.getPanels();var h,g,e;a(f).each(function(){if(this.panel==d){h=this.rowIndex;g=this.columnIndex;e=this.index}});c.rows[h].columns[g].panels.splice(e,1);b.rows[h].columns[g].panels.splice(e,1)}},_renderColumn:function(n){var f=n.column,o=n.columnIndex,s=n.jcolumn;var q=n.rowIndex;var k=this,c=this.options;var r={element:s[0]};if(f.width){s.width(f.width)}if(f.height){s.height(f.height)}if(f.panels){r.panels=[]}if(f.panels&&f.panels.length){for(var j=0;j<f.panels.length;j++){var b=f.panels[j];var m=a("<div></div>").appendTo(s);r.panels[j]=m.ligerPanel(b);r.panels[j].bind("closed",k._createPanelClosed());k.setPanelEvent({panel:r.panels[j]})}}else{if(k.tempInitPanels){var d=k.tempInitPanels.find(">div:eq("+o+")");if(d.length){r.panels=[];var t={};var h=d.clone();if(liger.inject&&liger.inject.getOptions){t=liger.inject.getOptions({jelement:h,defaults:a.ligerDefaults.Panel,config:liger.inject.config.Panel})}r.panels[0]=h.appendTo(s).ligerPanel(t);r.panels[0].bind("closed",k._createPanelClosed());k.setPanelEvent({panel:r.panels[0]})}}}r.jplace=a('<div class="l-column-place"></div>').appendTo(s);return r},setPanelEvent:function(h){var b=h.panel,d=b.panel;var c=this,f=this.options;if(a.fn.ligerDrag&&f.draggable){d.addClass("l-panel-draggable").ligerDrag({proxy:false,revert:true,handler:".l-panel-header span:first",onRendered:function(){},onStartDrag:function(j,g){c.portal.find(">.l-row").addClass("l-row-dragging");this.jplace=a('<div class="l-panel-place"></div>');this.jplace.height(d.height());d.width(d.width());d.addClass("l-panel-dragging");d.css("position","absolute");d.after(this.jplace);c._updatePortal()},onDrag:function(t,u){var q=u.pageX||u.screenX,n=u.pageY||u.screenY;var v=d.height(),j=d.width(),o=d.offset();var p=o.left+j/2,m=o.top+10;var s=c.getPanels(),k=c.getEmptyColumns();var w=g(s,k,p,m);if(w){if(this.placeStatus){if(this.placeStatus.panel&&w.panel){if(this.placeStatus.panel.rowIndex==w.panel.rowIndex&&this.placeStatus.panel.columnIndex==w.panel.columnIndex&&this.placeStatus.panel.index==w.panel.index&&this.placeStatus.position==w.position){return}}if(this.placeStatus.column&&w.column){if(this.placeStatus.column.rowIndex==w.column.rowIndex&&this.placeStatus.column.columnIndex==w.column.columnIndex&&this.placeStatus.position==w.position){return}}}if(w.position=="top"){this.jplace.insertBefore(w.panel?w.panel.jpanel:w.column.jplace);this.savedPosition=w.panel?w.panel:w.column;this.savedPosition.inTop=true}else{if(w.position=="bottom"){this.jplace.insertAfter(w.panel.jpanel);this.savedPosition=w.panel;this.savedPosition.inTop=false}}this.placeStatus=w}else{this.placeStatus=null}function g(z,A,e,E){for(i=0,l=z.length;i<l;i++){var D=z[i];if(D.panel==b){continue}var C=r(D,null,e,E);if(C){return C}}for(i=0,l=A.length;i<l;i++){var B=A[i];var C=r(null,B,e,E);if(C){return C}}return null}function r(e,B,F,E){var C=e?e.jpanel:B.jplace;if(!C){return null}var H=C.height(),z=C.width();var A=C.offset().left,D=C.offset().top;var G=3;if(F>A-G&&F<A+z+G){if(E>D-G&&E<D+H/2+G){return{panel:e,column:B,position:"top"}}if(E>D+H/2-G&&E<D+H+G){return{panel:e,column:B,position:e?"bottom":"top"}}}return null}},onStopDrag:function(o,n){c.portal.find(">.l-row").removeClass("l-row-dragging");b.set("width",b.get("width"));d.removeClass("l-panel-dragging");if(this.jplace){d.css({position:"relative",left:null,top:null});d.insertAfter(this.jplace);c.portal.find(">.l-row > .l-column >.l-panel-place").remove();if(this.savedPosition){var j=c.getPanels();var q,k,g;a(j).each(function(){if(this.panel==b){q=this.rowIndex;k=this.columnIndex;g=this.index}});var p=f.rows[q].columns[k].panels[g];var m=c.rows[q].columns[k].panels[g];f.rows[q].columns[k].panels.splice(g,1);c.rows[q].columns[k].panels.splice(g,1);if(this.savedPosition.panel){f.rows[this.savedPosition.rowIndex].columns[this.savedPosition.columnIndex].panels.splice(this.savedPosition.index+this.savedPosition.inTop?-1:0,0,p);c.rows[this.savedPosition.rowIndex].columns[this.savedPosition.columnIndex].panels.splice(this.savedPosition.index+this.savedPosition.inTop?-1:0,0,m)}else{f.rows[this.savedPosition.rowIndex].columns[this.savedPosition.columnIndex].panels=[p];c.rows[this.savedPosition.rowIndex].columns[this.savedPosition.columnIndex].panels=[m]}}}c._updatePortal();return false}})}},_updatePortal:function(){var b=this,c=this.options;a(b.rows).each(function(d){a(this.columns).each(function(e){if(this.panels&&this.panels.length){a(this.element).removeClass("l-column-empty")}else{a(this.element).addClass("l-column-empty")}})})},getPanels:function(){var c=this,d=this.options;var b=[];a(c.rows).each(function(e){a(this.columns).each(function(f){a(this.panels).each(function(g){b.push({rowIndex:e,columnIndex:f,index:g,panel:this,jpanel:this.panel})})})});return b},getPanel:function(f){var c=this,d=this.options;f=a.extend({rowIndex:0,columnIndex:0,index:0},f);var b=null;a(c.rows).each(function(e){a(this.columns).each(function(g){a(this.panels).each(function(h){if(b){return}if(e==f.rowIndex&&g==f.columnIndex&&h==f.index){b=this}})})});return b},getEmptyColumns:function(){var c=this,d=this.options;var b=[];a(c.rows).each(function(e){a(this.columns).each(function(f){if(!this.panels||!this.panels.length){b.push({rowIndex:e,columnIndex:f,jplace:this.jplace})}})});return b},_setUrl:function(b){var c=this,d=this.options;if(!b){return}a.ajax({url:b,data:d.parms,type:d.method,dataType:"json",success:function(e){c.set("rows",e)}})},_setWidth:function(b){b&&this.portal.width(b)},collapseAll:function(){var c=this,d=this.options;var b=c.getPanels();a(b).each(function(f,g){var e=g.panel;e.collapse()})},expandAll:function(){var c=this,d=this.options;var b=c.getPanels();a(b).each(function(f,g){var e=g.panel;e.expand()})}})})(jQuery);