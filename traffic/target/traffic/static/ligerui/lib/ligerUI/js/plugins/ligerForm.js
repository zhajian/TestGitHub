(function(a){a.fn.ligerForm=function(){return a.ligerui.run.call(this,"ligerForm",arguments)};a.ligerui.getConditions=function(d,c){if(!d){return null}d=liger.get(a(d));if(d&&d.toConditions){return d.toConditions()}};a.ligerDefaults=a.ligerDefaults||{};a.ligerDefaults.Form={width:null,inputWidth:180,labelWidth:90,space:40,rightToken:"：",labelAlign:"left",align:"left",fields:[],appendID:true,prefixID:null,toJSON:a.ligerui.toJSON,labelCss:null,fieldCss:null,spaceCss:null,onAfterSetFields:null,buttons:null,readonly:false,editors:{},validate:null,unSetValidateAttr:false};a.ligerDefaults.FormString={invalidMessage:"存在{errorCount}个字段验证不通过，请检查!",detailMessage:"详细",okMessage:"确定"};a.ligerDefaults.Form.editors.textarea={create:function(c,f,e){var d=a('<textarea class="l-textarea" />');var g=(e.prefixID||"")+f.field.name;if(a("#"+g).length){d=a("#"+g)}d.attr({id:g,name:g});if(e.readonly){d.attr("readonly",true)}c.append(d);return d},getValue:function(c,d){return c.val()},setValue:function(c,d,e){c.val(d)},resize:function(e,d,c,f){e.css({width:d-2}).parent().css("width","auto")}};a.ligerDefaults.Form.editors.hidden={create:function(c,f,e){var d=a('<input type = "hidden"  />');var g=(e.prefixID||"")+f.field.name;if(a("#"+g).length){d=a("#"+g)}d.attr({id:g,name:g});c.append(d);return d},getValue:function(c,d){return c.val()},setValue:function(c,d,e){c.val(d)}};a.ligerDefaults.Form_fields={name:null,textField:null,type:null,editor:null,label:null,newline:true,op:null,vt:null,attr:null,validate:null};a.ligerDefaults.Form_editor={};a.ligerDefaults.Form.editorBulider=function(i){var e=this,h=this.options;var c={},d=i.attr("ltype"),f={};if(h.readonly){c.readonly=true}c=a.extend({width:(f.width||h.inputWidth)-2},f.options,f.editor,c);if(d=="autocomplete"){c.autocomplete=true}if(i.is("select")){i.ligerComboBox(c)}else{if(i.is(":password")){i.ligerTextBox(c)}else{if(i.is(":text")){switch(d){case"select":case"combobox":case"autocomplete":i.ligerComboBox(c);break;case"spinner":i.ligerSpinner(c);break;case"date":i.ligerDateEditor(c);break;case"popup":i.ligerPopupEdit(c);break;case"currency":c.currency=true;case"float":case"number":c.number=true;i.ligerTextBox(c);break;case"int":case"digits":c.digits=true;default:i.ligerTextBox(c);break}}else{if(i.is(":radio")){i.ligerRadio(c)}else{if(i.is(":checkbox")){i.ligerCheckBox(c)}else{if(i.is("textarea")){i.addClass("l-textarea")}}}}}}};a.ligerui.controls.Form=function(d,c){a.ligerui.controls.Form.base.constructor.call(this,d,c)};a.ligerui.controls.Form.ligerExtend(a.ligerui.core.UIComponent,{__getType:function(){return"Form"},__idPrev:function(){return"Form"},_init:function(){var e=this,f=this.options;a.ligerui.controls.Form.base._init.call(this);for(var d in liger.editors){var c=liger.editors[d];if(!c||d in f.editors){continue}f.editors[d]=liger.getEditor(a.extend({type:d,master:e},c))}},_render:function(){var d=this,e=this.options;var c=a(this.element);d.form=c.is("form")?c:c.parents("form:first");a("input,select,textarea",c).each(function(){e.editorBulider.call(d,a(this))});d.set(e);if(e.buttons){var f=a('<ul class="l-form-buttons"></ul>').appendTo(c);a(e.buttons).each(function(){var g=a("<li><div></div></li>").appendTo(f);a("div:first",g).ligerButton(this)})}if(!d.element.id){d.element.id=d.id}a("#"+d.element.id+" .togglebtn").live("click",function(){if(a(this).hasClass("togglebtn-down")){a(this).removeClass("togglebtn-down")}else{a(this).addClass("togglebtn-down")}var g=a(this).parent().nextAll("ul,div");for(var h=0;h<g.length;h++){var j=a(g[h]);if(j.hasClass("l-group")){break}if(a(this).hasClass("togglebtn-down")){j.hide()}else{j.show()}}})},_setWidth:function(d){var c=this,e=this.options;if(d){c.form.width(d)}},getEditor:function(d){var f=this,j=this.options;if(!f.editors){return}for(var e=0,c=j.fields.length;e<c;e++){var h=j.fields[e];if(h.name==d&&f.editors[e]){return f.editors[e].control}}},getField:function(c){var d=this,e=this.options;if(!e.fields){return null}return e.fields[c]},toConditions:function(){var c=this,e=this.options;var d=[];a(e.fields).each(function(h,k){var g=k.name,f=k.textField,i=c.editors[h];if(!i||!g){return}var j=i.editor.getValue(i.control);if(j!=null&&j!==""){d.push({op:k.operator||"like",field:g,value:j,type:k.type||"string"})}});return d},_preSetFields:function(c){var e=this,h=this.options,d=null,f=null;a(h.fields).each(function(g,j){if(h.readonly||j.readonly||(j.editor&&j.editor.readonly)){delete j.validate}if(j.type=="hidden"){return}j.type=j.type||"text";if(j.newline==null){j.newline=true}if(d&&!j.group){j.group=d;j.groupicon=f}if(j.group){j.group=j.group.toString().replace(/^\s\s*/,"").replace(/\s\s*$/,"");d=j.group;f=j.groupicon}})},_setReadonly:function(c){var e=this,h=this.options;if(c&&e.editors){for(var d in e.editors){var f=e.editors[d].control;if(f&&f._setReadonly){f._setReadonly(true)}}}},_setFields:function(h){var f=this,c=this.options;if(a.isFunction(c.prefixID)){c.prefixID=c.prefixID(f)}f.validate={};var l=a(this.element);a(".l-form-container",l).remove();var i=0,k=0;if(h&&h.length){f._preSetFields(h);if(!l.hasClass("l-form")){l.addClass("l-form")}var e=['<div class="l-form-container">'];var j=false,m=null;var d=[];a(h).each(function(o,q){var n=q.name,g=(q.readonly||(q.editor&&q.editor.readonly))?true:false,p=(c.prefixID||"")+(q.textField||q.id||q.name);if(q.validate&&!g){f.validate.rules=f.validate.rules||{};f.validate.rules[p]=q.validate;if(q.validateMessage){f.validate.messages=f.validate.messages||{};f.validate.messages[p]=q.validateMessage}}if(a.inArray(q.group,d)==-1){d.push(q.group)}});a(d).each(function(g,n){a(h).each(function(s,t){if(t.group!=n){return}var r=a.inArray(t,h);var q=t.id||t.name,o=t.newline;var p=(c.prefixID||"")+(t.id||t.name);if(!q){return}if(t.type=="hidden"){if(!a("#"+p).length){e.push('<div style="display:none" id="'+(f.id+"|"+s)+'"></div>')}return}var u=t.group&&t.group!=m;if(r==0||u){o=true}if(o){i=0;if(j){e.push("</ul>");j=false}if(u){e.push('<div class="l-group');if(t.groupicon){e.push(" l-group-hasicon")}e.push('">');if(t.groupicon){e.push('<img src="'+t.groupicon+'" />')}e.push("<span>"+t.group+"</span></div>");m=t.group}e.push("<ul>");j=true}e.push('<li class="l-fieldcontainer');if(o){e.push(" l-fieldcontainer-first")}e.push('"');e.push(" fieldindex="+r);e.push("><ul>");e.push(f._buliderLabelContainer(t,r));e.push(f._buliderControlContainer(t,r));e.push(f._buliderSpaceContainer(t,r));e.push("</ul></li>");i+=(t.width||c.inputWidth||0);i+=(t.space||c.space||0);i+=(t.labelWidth||c.labelWidth||0);if(i>k){k=i}})});if(j){e.push("</ul>");j=false}e.push("</div>");l.append(e.join(""));if(!c.width||k>c.width){l.width(k+10)}a(".l-group .togglebtn",l).remove();a(".l-group",l).width(l.width()*0.95).append("<div class='togglebtn'></div>")}(function(){f.editors=f.editors||{};a(h).each(function(n,q){var g=document.getElementById(f.id+"|"+n),p=c.editors[q.type];if(!g){return}g=a(g);var o=f._createEditor(p,g,{field:q},g.width(),g.height());if(f.editors[n]&&f.editors[n].control&&f.editors[n].control.destroy){f.editors[n].control.destroy()}f.editors[n]={control:o,editor:p}});f.initValidate();f.trigger("afterSetFields")})()},getData:function(){var c=this,d=this.options;c.data={};a(d.fields).each(function(g,j){var f=j.name,e=j.textField,h=c.editors[g];if(!h){return}if(f){var i=h.editor.getValue(h.control);c._setValueByName(c.data,f,i)}if(e){var i=h.editor.getText(h.control);c._setValueByName(c.data,e,i)}});return c.data},setData:function(e){var d=this,f=this.options;var c=d.get("fields");d.data=e||{};(function(){a(c).each(function(i,l){var h=l.name,g=l.textField,j=d.editors[i];if(!j){return}if(h&&(h in d.data)){var k=d._getValueByName(d.data,h);j.editor.setValue(j.control,k)}if(g&&(g in d.data)){var m=d._getValueByName(d.data,g);j.editor.setText(j.control,m)}})})()},_setValueByName:function(f,c,d){if(!f||!c){return null}if(c.indexOf(".")==-1){f[c]=d}else{try{new Function("data,value","data."+c+"=value;")(f,d)}catch(g){}}},_getValueByName:function(d,c){if(!d||!c){return null}if(c.indexOf(".")==-1){return d[c]}else{try{return new Function("data","return data."+c+";")(d)}catch(f){return null}}},valid:function(){var c=this,d=this.options;if(!c.form||!c.validator){return}return c.form.valid()},initValidate:function(){var d=this,e=this.options;if(!d.form||!e.validate||!d.form.validate){d.validator=null;return}var f=e.validate==true?{}:e.validate;var c=a.extend({errorPlacement:function(g,h){if(!h.attr("id")){h.attr("id",new Date().getTime())}if(h.hasClass("l-textarea")){h.addClass("l-textarea-invalid")}else{if(h.hasClass("l-text-field")){h.parent().addClass("l-text-invalid")}}a(h).removeAttr("title").ligerHideTip();a(h).attr("title",g.html()).ligerTip({distanceX:5,distanceY:-3,auto:true})},success:function(g){if(!g.attr("for")){return}var h=a("#"+g.attr("for"));if(h.hasClass("l-textarea")){h.removeClass("l-textarea-invalid")}else{if(h.hasClass("l-text-field")){h.parent().removeClass("l-text-invalid")}}a(h).removeAttr("title").ligerHideTip()}},f,{rules:d.validate.rules,messages:d.validate.messages});d.validator=d.form.validate(c)},showInvalid:function(c){var d=this,e=this.options;if(!d.validator){return}var f=a('<div><div class="invalid">'+e.invalidMessage.replace("{errorCount}",d.validator.errorList.length)+'<a class="viewInvalidDetail" href="javascript:void(0)">'+e.detailMessage+'</a></div><div class="invalidDetail" style="display:none;">'+b(d.validator.errorList)+"</div></div>");f.find("a.viewInvalidDetail:first").bind("click",function(){a(this).parent().next("div.invalidDetail").toggle()});a.ligerDialog.open({type:"error",width:350,showMax:false,showToggle:false,showMin:false,target:f,buttons:[{text:e.okMessage,onclick:function(g,h){h.close()}}]})},_createEditor:function(i,d,k,f,c){var h=this,j=this.options;var e=i.create.call(this,d,k,j);if(e&&i.resize){i.resize.call(this,e,f,c,k)}return e},_buliderLabelContainer:function(j){var h=this,i=this.options;var e=j.label||j.display;var c=j.labelWidth||j.labelwidth||i.labelWidth;var f=j.labelAlign||i.labelAlign;if(e){e+=i.rightToken}var d=[];d.push("<li");if(i.labelCss){d.push(' class="'+i.labelCss+'"')}d.push(' style="');if(/px$/i.test(c)||/auto/i.test(c)||/%$/i.test(c)){d.push("width:"+c+";")}else{if(c){d.push("width:"+c+"px;")}}if(f){d.push("text-align:"+f+";")}d.push('">');if(e){d.push(e)}d.push("</li>");return d.join("")},_buliderControlContainer:function(i,d){var f=this,h=this.options;var e=i.width||h.inputWidth;var j=i.align||i.textAlign||i.textalign||h.align;var c=[];c.push("<li");c.push(' id="'+(f.id+"|"+d)+'"');if(h.fieldCss){c.push(' class="'+h.fieldCss+'"')}c.push(' style="');if(e){c.push("width:"+e+"px;")}if(j){c.push("text-align:"+j+";")}c.push('">');c.push("</li>");return c.join("")},_buliderSpaceContainer:function(h){var d=this,f=this.options;var e=h.space||h.spaceWidth||f.space;if(h.space===0||h.spaceWidth===0){e=0}var c=[];c.push("<li");if(f.spaceCss){c.push(' class="'+f.spaceCss+'"')}c.push(' style="');if(/px$/i.test(e)||/auto/i.test(e)||/%$/i.test(e)){c.push("width:"+e+";")}if(e){c.push("width:"+e+"px;")}c.push('">');if(h.validate&&h.validate.required){c.push("<span class='l-star'>*</span>")}c.push("</li>");return c.join("")},_buliderControl:function(k,l){var i=this,d=this.options;var e=k.width||d.inputWidth,c=k.name||k.id,j=(k.type||"text").toLowerCase(),h=(k.readonly||(k.editor&&k.editor.readonly))?true:false;var f=[];if(j=="textarea"||j=="htmleditor"){f.push("<textarea ")}else{if(a.inArray(j,["checkbox","radio","password","file"])!=-1){f.push('<input type="'+j+'" ')}else{if(a.inArray(j,["select","combobox","autocomplete","popup","radiolist","checkboxlist","listbox"])!=-1){f.push('<input type="hidden" ')}else{f.push('<input type="text" ')}}}f.push('name="'+c+'" ');f.push('fieldindex="'+l+'" ');k.cssClass&&f.push('class="'+k.cssClass+'" ');d.appendID&&f.push(' id="'+c+'" ');f.push(i._getInputAttrHtml(k));if(k.validate&&!h){f.push(" validate='"+d.toJSON(k.validate)+"' ");i.validate=i.validate||{};i.validate.rules=i.validate.rules||{};i.validate.rules[c]=k.validate;if(k.validateMessage){i.validate.messages=i.validate.messages||{};i.validate.messages[c]=k.validateMessage}}f.push(" />");return f.join("")},_getInputAttrHtml:function(f){var c=[],d=(f.type||"text").toLowerCase();if(d=="textarea"){f.cols&&c.push('cols="'+f.cols+'" ');f.rows&&c.push('rows="'+f.rows+'" ')}c.push('ltype="'+d+'" ');f.op&&c.push('op="'+f.op+'" ');f.vt&&c.push('vt="'+f.vt+'" ');if(f.attr){for(var e in f.attr){c.push(e+'="'+f.attr[e]+'" ')}}return c.join("")}});function b(d){var c=[];a(d).each(function(g,f){var e=a(f.element).parents("li:first").prev("li:first").html();var h=f.message;c.push("<div>"+e+" "+h+"</div>")});return c.join("")}})(jQuery);